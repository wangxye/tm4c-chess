# tm4c-chess-music

## 一、项目概述

### 1.1 功能

本项目最终实现的主要功能有：

- 中国象棋游戏。
- 音乐播放器。

### 1.2 创意点

- 利用机械按键选中、控制象棋棋子移动，实现实时象棋对弈。
- 亦可以通过红外遥控实现对象棋的控制。
- 利用加速度计采集到通过板子的倾斜运动，使得棋盘可以自动重启初始化。
- 利用自定义先入先出队列实现棋盘复盘。
- 利用自定义后入先出堆栈实现棋盘悔棋。
- 音乐播放器可以实现暂停播放，快进固定时间和倒退固定时间的功能。
- 音乐播放器可以设置循环播放/单曲循环模式。
- 音乐播放在定时器中断实现所以可以在象棋游戏中播放。
- 在程序运行后，棋盘初始化成功后，米字管显示象棋比分。

### 1.3 设计外设

- TFT显示
- TFT触摸
- 机械按键
- 红外遥控
- 蜂鸣器
- LED模块
- 加速度计

## 二、设计思路

### 1.1 象棋

  象棋主要通过定时采集机械按键和红外遥控的输入输出信号，来实现对棋盘中十字的移动、选中棋子。在初始化棋盘时，给定操作十字的初始位置，通过按键、红外遥控，发出的按键指令，来控制对十字位置坐标的移动，来选中棋子，移动棋子、撤销棋子选中状态、悔棋与复盘功能，针对不同棋子，制定的不同规则。当某一方棋子将军后，米字管更新比分情况，棋盘会进入重置模式，通过定时采集板子上重力加速度计来实现对棋盘的重启。当多次检测到棋盘的Y轴巨大变化时，剔除突变值后，重置棋盘，复原棋子，实现棋盘重置操作。与此同时，可通过机械按键后红外遥控，来复盘上局对弈情况。在对弈过程中，在双方允许的情况下，可实现悔棋操作。

### 1.2 音乐播放器

  音乐播放器主要是通过板上资源产生的PWM波来控制外接的无源蜂鸣器的声音来实现音乐播放的效果。其中蜂鸣器发出的音调是由PWM波的频率来控制的，而音量由PWM的占空比决定。要播放的音乐乐谱我们由我们提前输入记录，我们将这一段音乐中每一个音符的音调高低以及持续时间分别列成两个表。在播放音乐时，由定时器来定时每个音调所持续的时间，时间一到就跳到下个音符，同时蜂鸣器口PWM波的输出频率变为相应音符对应的频率，之后定时器再开始计时当前音符所持续的时间。暂停功能即暂时记录下当前播放的音符位置以及已播放的时间，在下次点击播放时再从这里开始。快进和倒退是通过事先计算确定相应歌曲前或后5s时所对应的音符位置，将当前播放的音符点直接跳转到该点，从而实现播放时间上的改变。在音符播放的总入口函数有判断音乐播放的标志位来选择读取哪首音乐的音符表，因而要实现切歌，只需要改变全局的播放标志位，重置播放进度的数据就可以了。